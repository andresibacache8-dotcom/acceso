<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico P√≥rtico - Visitas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1000px; background: white; padding: 30px; border-radius: 8px; }
        .section { margin-bottom: 30px; }
        .section h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .code-block { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        table { width: 100%; border-collapse: collapse; }
        table td { padding: 10px; border: 1px solid #ddd; }
        table th { background: #3498db; color: white; padding: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico del M√≥dulo P√≥rtico - Visitas</h1>

        <div class="section">
            <h3>1Ô∏è‚É£ Consultar Visitas en BD</h3>
            <p>Ejecuta esta consulta en tu base de datos para ver qu√© visitas tienes registradas:</p>
            <div class="code-block">
                <pre>SELECT id, nombre, rut, empresa, status, acceso_permanente, fecha_expiracion, en_lista_negra FROM visitas LIMIT 20;</pre>
            </div>
            <button class="btn btn-primary" onclick="testGetVisitas()">Probar GET de Visitas</button>
            <div id="result-visitas" class="mt-3"></div>
        </div>

        <div class="section">
            <h3>2Ô∏è‚É£ Probar Escaneo de Visita</h3>
            <p>Ingresa el RUT de una visita para probar el p√≥rtico:</p>
            <div class="input-group mb-3">
                <input type="text" id="visitaRut" class="form-control" placeholder="Ej: 12345678" value="">
                <button class="btn btn-success" onclick="testScanVisita()">Probar Escaneo</button>
            </div>
            <div id="result-scan" class="mt-3"></div>
        </div>

        <div class="section">
            <h3>3Ô∏è‚É£ Posibles Problemas y Soluciones</h3>
            <table>
                <tr>
                    <th>Problema</th>
                    <th>Causa</th>
                    <th>Soluci√≥n</th>
                </tr>
                <tr>
                    <td><span class="error">404 Not Found</span></td>
                    <td>Visita no existe en BD</td>
                    <td>Crear una visita nueva con status='autorizado'</td>
                </tr>
                <tr>
                    <td><span class="error">403 Denegado</span></td>
                    <td>Visita existe pero NO est√° autorizada o fecha expir√≥</td>
                    <td>Actualizar status a 'autorizado' y fecha_expiracion futura</td>
                </tr>
                <tr>
                    <td><span class="warning">No aparece en logs</span></td>
                    <td>Acceso registrado pero tabla no carga</td>
                    <td>Revisar tabla access_logs y filtros</td>
                </tr>
                <tr>
                    <td><span class="warning">RUT no coincide</span></td>
                    <td>Escaneas un RUT que no existe</td>
                    <td>Verifica el RUT exacto en la tabla visitas</td>
                </tr>
            </table>
        </div>

        <div class="section">
            <h3>4Ô∏è‚É£ SQL para Crear Visita de Prueba</h3>
            <p>Copia y ejecuta en tu BD para crear una visita de prueba:</p>
            <div class="code-block">
                <pre>INSERT INTO visitas (nombre, rut, empresa, tipo, status, acceso_permanente, fecha_expiracion, en_lista_negra)
VALUES ('Juan P√©rez Visita', '98765432', 'Empresa Test', 'proveedor', 'autorizado', 0, DATE_ADD(NOW(), INTERVAL 30 DAY), 0);</pre>
            </div>
        </div>

        <div class="section">
            <h3>5Ô∏è‚É£ Verificar Respuesta de portico.php</h3>
            <p>Haz una petici√≥n POST directo a portico.php:</p>
            <div class="input-group mb-3">
                <input type="text" id="directRut" class="form-control" placeholder="RUT a probar" value="12345678">
                <button class="btn btn-warning" onclick="testDirectPortico()">Probar Directo</button>
            </div>
            <div id="result-direct" class="mt-3"></div>
        </div>

        <div class="section" style="background: #f0f7ff; padding: 15px; border-radius: 5px;">
            <h4>üí° Pasos Recomendados:</h4>
            <ol>
                <li>Haz click en "Probar GET de Visitas" para ver qu√© visitas existen</li>
                <li>Copia el RUT de una visita autorizada</li>
                <li>P√©galo en "Probar Escaneo" y haz click</li>
                <li>Si obtiene error 404, usa el SQL para crear una visita de prueba</li>
                <li>Si obtiene error 403, actualiza el status a 'autorizado'</li>
            </ol>
        </div>
    </div>

    <script>
        async function testGetVisitas() {
            const resultDiv = document.getElementById('result-visitas');
            resultDiv.innerHTML = '<div class="alert alert-info">Cargando...</div>';

            try {
                const response = await fetch('api/visitas.php');
                const data = await response.json();

                if (!response.ok) {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.message || response.statusText}</div>`;
                    return;
                }

                if (!data || (Array.isArray(data) && data.length === 0)) {
                    resultDiv.innerHTML = '<div class="alert alert-warning"><strong>‚ö†Ô∏è No hay visitas registradas</strong></div>';
                    return;
                }

                let html = '<div class="alert alert-success"><strong>‚úÖ Visitas encontradas:</strong></div><table class="table table-sm table-bordered"><tr><th>ID</th><th>Nombre</th><th>RUT</th><th>Empresa</th><th>Status</th><th>Autorizado</th><th>Exp. Date</th></tr>';

                if (Array.isArray(data)) {
                    data.forEach(v => {
                        html += `<tr>
                            <td>${v.id}</td>
                            <td>${v.nombre}</td>
                            <td><strong>${v.rut}</strong></td>
                            <td>${v.empresa}</td>
                            <td><span class="${v.status === 'autorizado' ? 'success' : 'error'}">${v.status}</span></td>
                            <td>${v.acceso_permanente ? '‚úì Permanente' : '‚úó Temporal'}</td>
                            <td>${v.fecha_expiracion || 'N/A'}</td>
                        </tr>`;
                    });
                }

                html += '</table>';
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
            }
        }

        async function testScanVisita() {
            const rut = document.getElementById('visitaRut').value.trim();
            const resultDiv = document.getElementById('result-scan');

            if (!rut) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Ingresa un RUT</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="alert alert-info">Escanenando: ' + rut + '...</div>';

            try {
                const response = await fetch('api/portico.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: rut })
                });

                const data = await response.json();

                if (!response.ok) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>‚ùå Error ${response.status}</strong><br>
                            Mensaje: ${data.message || 'Error desconocido'}<br>
                            <small>Posibles causas:</small><br>
                            <ul>
                                <li>RUT no existe en la tabla visitas</li>
                                <li>Visita no est√° autorizada (status ‚â† 'autorizado')</li>
                                <li>Autorizaci√≥n expirada</li>
                            </ul>
                        </div>
                    `;
                    return;
                }

                if (data.action === 'clarification_required') {
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è Se requiere aclaraci√≥n</strong><br>
                            Nombre: ${data.person_details.name}<br>
                            RUT: ${data.person_details.rut}
                        </div>
                    `;
                    return;
                }

                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ Acceso registrado correctamente</strong><br>
                        ID: ${data.id}<br>
                        Tipo: ${data.type}<br>
                        Nombre: ${data.name}<br>
                        Acci√≥n: <strong>${data.action}</strong><br>
                        Mensaje: ${data.message}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
            }
        }

        async function testDirectPortico() {
            const rut = document.getElementById('directRut').value.trim();
            const resultDiv = document.getElementById('result-direct');

            if (!rut) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Ingresa un RUT</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="alert alert-info">Enviando POST directo...</div>';

            try {
                const response = await fetch('api/portico.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: rut })
                });

                const contentType = response.headers.get('content-type');
                let data;

                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    data = { text: await response.text() };
                }

                resultDiv.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <strong>Status HTTP:</strong> ${response.status} ${response.statusText}
                        </div>
                        <div class="card-body">
                            <strong>Respuesta JSON:</strong>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
