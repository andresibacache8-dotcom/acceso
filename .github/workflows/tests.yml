name: Ejecutar Tests - SCAD

on:
  push:
    branches: [ main, refactor/phase1, develop ]
  pull_request:
    branches: [ main ]

jobs:
  backend-tests:
    name: Tests Backend (PHPUnit)
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Configurar PHP 8.1
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, pdo, pdo_mysql, json
          coverage: xdebug
          tools: composer

      - name: Validar composer.json
        run: composer validate

      - name: Instalar dependencias Composer
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Esperar a MySQL
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -u root -proot --silent; then
              echo "MySQL est√° listo"
              exit 0
            fi
            echo "Esperando MySQL... intento $i/30"
            sleep 1
          done
          exit 1

      - name: Crear base de datos de tests
        run: |
          mysql -h 127.0.0.1 -u root -proot test_db < /dev/null 2>/dev/null || true
        env:
          MYSQL_PWD: root

      - name: Ejecutar tests PHPUnit
        run: ./vendor/bin/phpunit --configuration phpunit.xml --coverage-clover=coverage.xml --coverage-text
        continue-on-error: true

      - name: Subir cobertura a Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: backend
          name: backend-coverage
        continue-on-error: true

  frontend-tests:
    name: Tests Frontend (Jest)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Configurar Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Instalar dependencias npm
        run: npm ci

      - name: Ejecutar tests Jest
        run: npm test -- --coverage

      - name: Subir cobertura a Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./tests/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
        continue-on-error: true

      - name: Mostrar resumen de cobertura
        run: |
          echo "## üìä Cobertura Frontend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reporte generado en: \`tests/coverage/\`" >> $GITHUB_STEP_SUMMARY
        if: always()

  e2e-tests:
    name: Tests E2E (Cypress)
    runs-on: ubuntu-latest

    services:
      php:
        image: php:8.1-apache
        options: >-
          --health-cmd="curl -f http://localhost || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Configurar Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Instalar dependencias npm
        run: npm ci

      - name: Ejecutar tests Cypress
        run: npm run e2e
        continue-on-error: true

      - name: Subir videos de Cypress
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: cypress-videos
          path: cypress/videos/
          retention-days: 7

      - name: Subir screenshots de Cypress
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots/
          retention-days: 7

  resultados:
    name: Resumen de Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests]
    if: always()

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Mostrar resumen
        if: always()
        run: |
          echo "‚úÖ Suite de Tests SCAD"
          echo "Backend (PHPUnit): ${{ needs.backend-tests.result }}"
          echo "Frontend (Jest): ${{ needs.frontend-tests.result }}"
          echo "E2E (Cypress): ${{ needs.e2e-tests.result }}"

      - name: Verificar estado
        if: always()
        run: |
          FRONTEND_STATUS="${{ needs.frontend-tests.result }}"
          E2E_STATUS="${{ needs.e2e-tests.result }}"

          echo "## üìä Resumen de Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend (PHPUnit) | ${{ needs.backend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend (Jest) | ${{ needs.frontend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E (Cypress) | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY

          if [ "$FRONTEND_STATUS" = "success" ] && [ "$E2E_STATUS" = "success" ]; then
            echo "‚úÖ Tests Frontend y E2E: √âXITO"
            exit 0
          else
            echo "‚ùå Tests Frontend o E2E: FALL√ì"
            exit 1
          fi
